---
title: "scRNA-Seq Analysis: Radiation and Trametinib Resistance in pHGG"
author: "J. O'Connor"
date: "2025-06-12"
output: html_document
---

# Environment Setup
We load the Seurat ecosystem for single-cell analysis and Harmony for batch integration. We also include clusterProfiler for downstream pathway analysis.

```{r setup, message=FALSE}
library(SeuratObject)
library(Seurat)
library(SeuratDisk)
library(ggplot2)
library(patchwork)
library(R.utils)
library(tidyr)
library(dplyr)
library(harmony)
library(ggrepel)
library(clusterProfiler)
library(org.Hs.eg.db)
library(msigdbr)
```

# Data Import

We load 16 individual 10X Genomics runs. These represent four experimental conditions:

1. Radiation + Trametinib: Resistant cells in treated mice.

2. Radiation + Vehicle: Resistant cells in control mice.

3. No Radiation + Trametinib: Wild-type cells in treated mice.

4. No Radiation + Vehicle: Wild-type cells in control mice.

```{r cars}

#Set directory where files are located (This is a flash drive location that needs to be changes to green lab directory)

file_dir <- "/Volumes/Untitled/"


# --- 1. Radiation/Trametinib Group ---
data.927 <- Read10X(data.dir = paste0(file_dir,"927_filtered_feature_bc_matrix"))
data.929 <- Read10X(data.dir = paste0(file_dir,"929_filtered_feature_bc_matrix"))
data.934 <- Read10X(data.dir = paste0(file_dir,"934_filtered_feature_bc_matrix"))

s927 <- CreateSeuratObject(counts = data.927) 
s929 <- CreateSeuratObject(counts = data.929) 
s934 <- CreateSeuratObject(counts = data.934)

# --- 2. Radiation/Vehicle Group ---
data.932 <- Read10X(data.dir = paste0(file_dir,"932_filtered_feature_bc_matrix"))
s932 <- CreateSeuratObject(counts = data.932) 

# --- 3. No Radiation/Trametinib Group ---
data.943 <- Read10X(data.dir = paste0(file_dir,"943_filtered_feature_bc_matrix"))
data.946 <- Read10X(data.dir = paste0(file_dir,"946_filtered_feature_bc_matrix"))
data.948 <- Read10X(data.dir = paste0(file_dir,"948_filtered_feature_bc_matrix"))
data.949 <- Read10X(data.dir = paste0(file_dir,"949_filtered_feature_bc_matrix"))
data.951 <- Read10X(data.dir = paste0(file_dir,"951_filtered_feature_bc_matrix"))

s943 <- CreateSeuratObject(counts = data.943) 
s946 <- CreateSeuratObject(counts = data.946)
s948 <- CreateSeuratObject(counts = data.948)
s949 <- CreateSeuratObject(counts = data.949)
s951 <- CreateSeuratObject(counts = data.951)

# --- 4. No Radiation/Vehicle Group ---
data.940 <- Read10X(data.dir = paste0(file_dir,"940_filtered_feature_bc_matrix"))
data.941 <- Read10X(data.dir = paste0(file_dir,"941_filtered_feature_bc_matrix"))
data.942 <- Read10X(data.dir = paste0(file_dir,"942_filtered_feature_bc_matrix"))
data.945 <- Read10X(data.dir = paste0(file_dir,"945_filtered_feature_bc_matrix"))
data.947 <- Read10X(data.dir = paste0(file_dir,"947_filtered_feature_bc_matrix"))
data.950 <- Read10X(data.dir = paste0(file_dir,"950_filtered_feature_bc_matrix"))
data.952 <- Read10X(data.dir = paste0(file_dir,"952_filtered_feature_bc_matrix"))
 
s940 <- CreateSeuratObject(counts = data.940) 
s941 <- CreateSeuratObject(counts = data.941)
s942 <- CreateSeuratObject(counts = data.942)
s945 <- CreateSeuratObject(counts = data.945)
s947 <- CreateSeuratObject(counts = data.947)
s950 <- CreateSeuratObject(counts = data.950)
s952 <- CreateSeuratObject(counts = data.952)

# Merge all samples into one object and add cell prefixes to identify the original "Run"
all.data <- merge(s927, y=c(s929, s934, s932, s943, s946, s948, s949, s951, s940, s941, s942, s945, s947, s950, s952), 
                  add.cell.ids=c("927", "929", "934", "932", "943", "946", "948", "949", "951", "940", "941", "942", "945", "947", "950", "952"), 
                  project="PHGG")


```

# Qualtiy Control and Metadata Assignment

We filter out low-quality cells (dying or empty droplets) and assign biological labels to each sample based on its ID.

```{r pressure, echo=FALSE}
# Calculate mitochondrial DNA percentage; high levels indicate stressed/dying cells
all.data[["percent.mt"]] <- PercentageFeatureSet(all.data, pattern = "^MT-")

# Filter: Keep cells with < 25% MT reads and between 200-7500 genes detected
selected <- WhichCells(all.data, expression = percent.mt < 25 & nFeature_RNA > 200 & nFeature_RNA < 7500)
all.data.filt <- subset(all.data, cells = selected)

# Define experimental groups for metadata mapping
rad_ids <- c("927","929","934","932")
norad_ids <- c("943","946","948","949","951","940","941","942","945","947","950", "952")
trt_ids <- c("927","929","934", "943","946","948","949","951")
no_trt_ids <- c("932","940","941","942","945","947","950","952")

all.data.filt@meta.data$Radiation <- ""
all.data.filt@meta.data$Treatment <- ""
all.data.filt@meta.data$Runs <- ""

# Loop through metadata to assign condition labels based on Sample ID (first 3 chars of barcode)
for (r in 1:nrow(all.data.filt@meta.data)) {
  sub_r <- substr(rownames(all.data.filt@meta.data)[r],1,3) 
  all.data.filt@meta.data$Runs[r] <- sub_r
  
  all.data.filt@meta.data$Radiation[r] <- ifelse(sub_r %in% rad_ids, "Radiation", "No Radiation")
  all.data.filt@meta.data$Treatment[r] <- ifelse(sub_r %in% trt_ids, "Trametinib", "Vehicle")
}

```


#Noramlization and Batch Correction

We use Harmony to integrate the runs. This prevents samples from clustering purely by "batch" (mouse ID) and allows us to see biological similarities across conditions.

```{r}

# Standard log-normalization and identification of top 2000 highly variable genes
all.data.filt <- NormalizeData(all.data.filt) %>% FindVariableFeatures() %>% ScaleData() %>% RunPCA(verbose = FALSE)

# Harmony integration: Aligning 'Runs' (Batch Correction)
all.data.filt <- RunHarmony(all.data.filt, group.by.vars = "Runs")

# UMAP visualization and Clustering
all.data.filt <- RunUMAP(all.data.filt, dims = 1:20)

#We also find the markers genes for clusters
```

# Cell Cylcle Regression

Cell cycle phase can dominate the variance in cancer cells. We calculate S/G2M scores and regress them out to focus on treatment-related transcriptomics.


```{r}
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes

# Calculate cell cycle scores
all.data.filt <- CellCycleScoring(all.data.filt, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

# Regression: Removing variance caused by cell proliferation states
all.data.filt <- ScaleData(all.data.filt, vars.to.regress = c("S.Score", "G2M.Score"), features = rownames(all.data.filt))

# Re-run Dimensionality reduction after regression
all.data.filt <- RunPCA(all.data.filt, verbose = FALSE)
all.data.filt <- RunUMAP(all.data.filt, dims = 1:20)


# Clustering is Performed
all.data.filt <- FindNeighbors(all.data.filt, reduction = "pca", dims = 1:20) %>% FindClusters(resolution=0.6)
 
# Genes Are identified and saved
all.data.filt.markers <- FindAllMarkers(all.data.filt, only.pos = TRUE)

write.csv(all.data.filt.markers, "../data/Seurat_Outputs/clustermarkers.csv")

#The processsed data is saved

# Create directory if it doesn't exist
if(!dir.exists("../data/R_Data_Objects")) dir.create("../data/R_Data_Objects", recursive = TRUE)

# Save the metadata dataframe
saveRDS(all.data.filt@meta.data, file = "../data/R_Data_Objects/all.data.filt.metadata.rds")

# Save the list of reductions
saveRDS(all.data.filt@reductions, file = "../data/R_Data_Objects/all.data.filt.reductions.rds")



```


# Dimensionality Reduction Plots (DimPlots)
We visualize the data to ensure cells are grouping by biology rather than technical batch.
```{r}

# 1. Plot by Mouse Run (Checking for remaining batch effects)
run_Dimplot <- DimPlot(all.data.filt, group.by = "Runs") + 
  ggtitle("UMAP by Sample Run")

# 2. Plot by Treatment Group (Trametinib vs Vehicle)
trt_DimPlot <- DimPlot(all.data.filt, group.by = "Treatment") + 
  ggtitle("UMAP by Treatment Group")

# 3. Plot by Radiation Status
rad_DimPlot <- DimPlot(all.data.filt, group.by = "Radiation") + 
  ggtitle("UMAP by Radiation Status")

# 4. Plot by Seurat Clusters (The primary unsupervised grouping)
cluster_Dimplot <- DimPlot(all.data.filt, group.by = "seurat_clusters", label = TRUE) + 
  ggtitle("Unsupervised Seurat Clusters")
```

# Marker Expression Analysis (DotPlots)

We use DotPlots to visualize the expression of key lineage markers and glioma-specific genes across our clusters.

```{r}

# 1. Original Genes / Lineage Markers
orig_genes_DotPlot <- DotPlot(all.data.filt, assay="RNA", 
        features=c("PSME2", "MAFB", "NKTR", "CD46", "VIM", "IGFBP2", "PTPRZ1", "OLIG2", "OLIG1", "ENC1", "ARC", "GAP43", "CHI3L1", "APOE", "GFAP", "PCLAF", "TYMS", "HIST1H1B", "RPS29", "MT-ND3"), 
        cols="RdBu", group.by="seurat_clusters") + 
        coord_flip() + geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +
        labs(x="Gene", y="Cluster", title="Lineage Marker Expression")

# 2. Cancer Stem Cell / Oligodendroglioma Markers
csc_genes_DotPlot <- DotPlot(all.data.filt, assay="RNA", 
        features=c("ASCL1", "BOC", "CCND2", "CD24", "CHD7", "EGFR", "NFIB", "SOX11", "SOX2", "SOX4", "TCF4"), 
        cols="RdBu", group.by="seurat_clusters") + 
        coord_flip() + labs(title="Cancer Stem Cell Markers")

# 3. Astrocyte Specific Markers
astro_genes_DotPlot <- DotPlot(all.data.filt, assay="RNA", 
        features=c("ALDH1L1", "AQP4", "ATP13A4", "BMPR1B", "SLC14A1", "SLC4A4", "GFAP"), 
        cols="RdBu", group.by="seurat_clusters") + 
        coord_flip() + labs(title="Astrocyte Markers")
```

#Saving Visualizations

We export the defined plots to the ../plots directory.
```{r}

# Ensure the directory exists
if(!dir.exists("../plots")) dir.create("../plots")

# Export UMAPs
ggsave("../plots/runs_umap.png", plot = run_Dimplot, width = 8, height = 6, dpi = 300)
ggsave("../plots/treatment_umap.png", plot = trt_DimPlot, width = 8, height = 6, dpi = 300)
ggsave("../plots/radiation_umap.png", plot = rad_DimPlot, width = 8, height = 6, dpi = 300)
ggsave("../plots/clusters_umap.png", plot = cluster_Dimplot, width = 8, height = 6, dpi = 300)

# Export DotPlots
ggsave("../plots/original_markers_dotplot.png", plot = orig_genes_DotPlot, width = 10, height = 8, dpi = 300)
ggsave("../plots/csc_markers_dotplot.png", plot = csc_genes_DotPlot, width = 10, height = 6, dpi = 300)
ggsave("../plots/astro_markers_dotplot.png", plot = astro_genes_DotPlot, width = 10, height = 6, dpi = 300)

```


# Differential Expression (DE) & Volcano Plots

We define specific clusters as "Resistant" vs "Sensitive" to Radiation/Trametinib and identify the genes driving these differences.

```{r}

# Defining functional cluster groups based on treatment response observed in UMAP (these can be manually adjusted)
trm_res_clusters <- c(3,9,6)
trm_sen_clusters <- c(0, 1, 2, 4, 5, 7, 8, 10, 11)

# Mapping Resistance status to Metadata
all.data.filt@meta.data$Radiation_Resistance <- ifelse(all.data.filt@meta.data$seurat_clusters %in% trm_res_clusters, "Radiation Resistant", "Radiation Sensitive")

# Subset and Find Markers for Resistance
rad.sub <- subset(all.data.filt, subset = Radiation_Resistance %in% c("Radiation Resistant", "Radiation Sensitive"))
Idents(rad.sub) <- "Radiation_Resistance"
rad_DE <- FindMarkers(rad.sub, ident.1 = "Radiation Resistant", ident.2 = "Radiation Sensitive")

# Calculate -log10(adj p-value) for volcano plotting
rad_DE$logpadj <- -1*(log10(rad_DE$p_val_adj))
rad_DE$Sig <- "Insignificant"
rad_DE$Label <- ""

# Labeling significant genes for the plot
for (i in 1:nrow(rad_DE)) {
  if (rad_DE$avg_log2FC[i]>0 & rad_DE$p_val_adj[i]<0.05) {
    rad_DE$Sig[i] <- "Increased with Sensitivity"
    rad_DE$Label[i] <- rownames(rad_DE)[i]
  } 
  if (rad_DE$avg_log2FC[i]<0 & rad_DE$p_val_adj[i]<0.05) {
    rad_DE$Sig[i] <- "Increased with Resistance"
    rad_DE$Label[i] <- rownames(rad_DE)[i]
  } 
}

# Generate Volcano Plot
Rad_Volc_plot <- ggplot(data=rad_DE, aes(x=avg_log2FC, y=logpadj, color=Sig)) +
  geom_point(size=3) +
  geom_text_repel(aes(label=Label)) +
  scale_color_manual(values=c("blue","red","gray")) +
  theme_classic() + labs(title="Radiation Resistance vs Sensitivity")

ggsave("../plots/Rad_Volc.png", plot = Rad_Volc_plot, width = 8, height = 6, dpi = 300)

# Define the specific groups based on your cluster logic
# Radiation Resistant & Trametinib Sensitive: 3
# Radiation Resistant & Trametinib Resistant: 6, 9
rad_res_trm_sen <- c(3)
rad_res_trm_res <- c(6, 9)

# Create a new metadata column for this specific comparison
all.data.filt@meta.data$Trm_Response_In_Rad_Resist <- "Other"
all.data.filt@meta.data$Trm_Response_In_Rad_Resist[all.data.filt@meta.data$seurat_clusters %in% rad_res_trm_sen] <- "Trm_Sensitive"
all.data.filt@meta.data$Trm_Response_In_Rad_Resist[all.data.filt@meta.data$seurat_clusters %in% rad_res_trm_res] <- "Trm_Resistant"

# Subset for ONLY these clusters to perform Differential Expression
sub_rad_res <- subset(all.data.filt, subset = Trm_Response_In_Rad_Resist %in% c("Trm_Sensitive", "Trm_Resistant"))
Idents(sub_rad_res) <- "Trm_Response_In_Rad_Resist"

# Find Markers: Trm Resistant vs Trm Sensitive (within the Radiation Resistant group)
trm_comp_DE <- FindMarkers(sub_rad_res, ident.1 = "Trm_Resistant", ident.2 = "Trm_Sensitive")

# Prep for Volcano Plot
trm_comp_DE$logpadj <- -log10(trm_comp_DE$p_val_adj)
trm_comp_DE$Sig <- "Insignificant"
trm_comp_DE$Label <- NA # Initializing as NA is cleaner for geom_text_repel

# Labeling significant genes
# Using a threshold of log2FC > 0.5 and p_val_adj < 0.05
for (i in 1:nrow(trm_comp_DE)) {
  if (trm_comp_DE$avg_log2FC[i] > 0.5 & trm_comp_DE$p_val_adj[i] < 0.05) {
    trm_comp_DE$Sig[i] <- "Up-regulated in Trm-Resistant"
    trm_comp_DE$Label[i] <- rownames(trm_comp_DE)[i]
  } 
  if (trm_comp_DE$avg_log2FC[i] < -0.5 & trm_comp_DE$p_val_adj[i] < 0.05) {
    trm_comp_DE$Sig[i] <- "Up-regulated in Trm-Sensitive"
    trm_comp_DE$Label[i] <- rownames(trm_comp_DE)[i]
  } 
}

# Generate Volcano Plot
Trm_Rad_Volc_plot <- ggplot(data=trm_comp_DE, aes(x=avg_log2FC, y=logpadj, color=Sig)) +
  geom_point(alpha=0.6, size=2) +
  geom_text_repel(aes(label=Label), max.overlaps = 15) +
  scale_color_manual(values=c("gray", "red", "blue")) +
  theme_classic() + 
  labs(title="Trametinib Response within Radiation Resistant Clusters",
       subtitle="Clusters 6 & 9 (Resistant) vs Cluster 3 (Sensitive)",
       x="log2 Fold Change", y="-log10 Adj P-value")

ggsave("../plots/Trm_Rad_Volc.png", plot = Trm_Rad_Volc_plot, width = 8, height = 6, dpi = 300)
```


# Functional Enrichment (GSEA)

We use the Hallmark gene sets to identify biological pathways (e.g., DNA Repair, Hypoxia) enriched in our resistant populations.

```{r}

# Rank genes by average log2 fold change for GSEA
rad_gene_list <- rad_DE %>% dplyr::select(avg_log2FC) %>% arrange(desc(avg_log2FC))
rad_gene_ranks <- rad_gene_list$avg_log2FC
names(rad_gene_ranks) <- rownames(rad_gene_list)

# Load Hallmark Gene Sets
hallmark <- msigdbr(species = "Homo sapiens", category = "H")
hallmark_t2g <- hallmark %>% dplyr::select(gs_name, gene_symbol)

# Run GSEA
rad_gsea_cancer <- GSEA(geneList = rad_gene_ranks, TERM2GENE = hallmark_t2g, pvalueCutoff = 0.05)

# Visualize enriched pathways
# (Logic for dotplots follows original script)

```


# Cell Type Annotation (ScType)

We use ScType to automatically assign biological cell types (Astrocyte, Oligo, etc.) to our clusters based on an internal database.

```{r}

# Loading ScType logic from source
source("[https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R](https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R)")
source("[https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_score_.R](https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_score_.R)")

# Prepare Brain-specific gene sets
gs_list <- gene_sets_prepare("[https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_full.xlsx](https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_full.xlsx)", "Brain")

# Calculate scores based on scaled data
scRNAseqData_scaled <- all.data.filt[["RNA"]]$scale.data
es.max <- sctype_score(scRNAseqData = scRNAseqData_scaled, scaled = TRUE, gs = gs_list$gs_positive, gs2 = gs_list$gs_negative)

# Assign the top-scoring cell type to each cluster
# (Logic for merging and assigning labels to metadata follows original script)
```


# Reference Mapping (Azimuth)

Finally, we project our cells onto the Human Motor Cortex reference to see how our tumor/treated cells map onto healthy brain hierarchies.

```{r}

# Load Azimuth reference (Motor Cortex)
reference <- LoadReference(path = "[https://seurat.nygenome.org/azimuth/references/v1.0.0/human_motorcortex](https://seurat.nygenome.org/azimuth/references/v1.0.0/human_motorcortex)")

# 1. SCTransform: Prepare query data for reference comparison
query <- SCTransform(all.data.filt, assay = "RNA", new.assay.name = "refAssay", 
                     residual.features = rownames(reference$map),
                     reference.SCT.model = reference$map[["refAssay"]]@SCTModel.list$refmodel,
                     method = 'glmGamPoi')

# 2. Anchoring: Find shared features between our cells and the brain atlas
anchors <- FindTransferAnchors(reference = reference$map, query = query, dims = 1:50, 
                               reference.reduction = "refDR", normalization.method = "SCT")

# 3. Label Transfer: Predict cell subclasses (e.g., L2/3 IT, VIP, Astro)
query <- TransferData(reference = reference$map, query = query, dims = 1:50, anchorset = anchors, 
                      refdata = list(subclass = reference$map[["subclass"]]))

# 4. NNTransform & Projection: Map query onto the Reference UMAP coordinates
# Internal function to handle downsampling indexing
NNTransform <- function(object, meta.data, neighbor.slot = "query_ref.nn", key = 'ori.index') {
  ind <- Indices(object[[neighbor.slot]])
  ori.index <- t(x = sapply(X = 1:nrow(ind), FUN = function(i) { return(meta.data[ind[i, ], key]) }))
  rownames(ori.index) <- rownames(ind)
  slot(object[[neighbor.slot]], name = "nn.idx") <- ori.index
  return(object)
}

query <- NNTransform(query, meta.data = reference$map[[]])

# Projection: Place cells on the gold-standard UMAP model
query[["proj.umap"]] <- RunUMAP(query[["query_ref.nn"]], reduction.model = reference$map[["refUMAP"]])

# Mapping Score: Metric of how well each cell fits the reference
query <- AddMetaData(query, metadata = MappingScore(anchors = anchors), col.name = "mapping.score")

```

# Cluster Abundance & Composition Analysis

This analysis calulates Log2  Fold Change (LFC) of cluster sizes. It allows us to identify "Resistance Hubs"â€”clusters that increase in frequency under both Radiation and Drug treatment.

```{r}

# 1. Initialize data frame for all 12 clusters (0-11)
FC_data <- as.data.frame(c(0,1,2,3,4,5,6,7,8,9,10,11))
colnames(FC_data) <- "cluster"
FC_data$log2FCRad <- NA
FC_data$log2FCtrt <- NA

# 2. Extract metadata and create frequency tables
seurat_meta <- all.data.filt@meta.data
tab_rad <- as.data.frame(table(seurat_meta$Radiation, seurat_meta$seurat_clusters))
tab_trt <- as.data.frame(table(seurat_meta$Treatment, seurat_meta$seurat_clusters))

# 3. Calculate Log2 Fold Change for each cluster across conditions
# Positive values indicate the cluster is more abundant in Radiation/Trametinib
for (r in 1:nrow(FC_data)) {
  clus_r <- FC_data$cluster[r]
  
  # Radiation LFC: log2(Radiation Count / No Radiation Count)
  FC_data$log2FCRad[r] <- log2(
    tab_rad$Freq[which(tab_rad$Var2==clus_r & tab_rad$Var1=="Radiation")] / 
    tab_rad$Freq[which(tab_rad$Var2==clus_r & tab_rad$Var1=="No Radiation")]
  )
  
  # Treatment LFC: log2(Trametinib Count / Vehicle Count)
  FC_data$log2FCtrt[r] <- log2(
    tab_trt$Freq[which(tab_trt$Var2==clus_r & tab_trt$Var1=="Trametinib")] / 
    tab_trt$Freq[which(tab_trt$Var2==clus_r & tab_trt$Var1=="Vehicle")]
  )
}

# 4. Define the Quadrant Plot
# This plot shows which clusters are "double resistant" (top-right quadrant)
Fc_plot <- ggplot(data=FC_data, aes(x=log2FCRad, y=log2FCtrt, color=as.factor(cluster))) +
  geom_point(size=3) +
  geom_text_repel(aes(label=cluster), size=4) +
  geom_hline(yintercept = 0, linetype="dashed", alpha=0.5) + # Baseline
  geom_vline(xintercept = 0, linetype="dashed", alpha=0.5) + # Baseline
  labs(x="Log2(FC Radiation)", 
       y="Log2(FC Drug)", 
       title="Cluster Abundance Shifts",
       color="Cluster") +
  theme_classic() +
  theme(legend.position = "right",
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 15))

# 5. Save the abundance plot
ggsave("../plots/cluster_abundance_quadrant.png", plot = Fc_plot, width = 8, height = 7, dpi = 300)

```


